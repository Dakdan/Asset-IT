<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ระบบซ่อมบำรุง IT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- STYLE หลัก (ห้ามหาย) -->
<link rel="stylesheet" href="./css/style.css">
<link rel="stylesheet" href="./css/ui.css">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">
</head>

<body class="login-page">

<div class="login-wrapper">

  <!-- HEADER -->
  <div class="login-header">
    <h1>ระบบซ่อมบำรุง IT</h1>
    <p>สำหรับเจ้าหน้าที่เทคโนโลยีสารสนเทศ</p>
  </div>

  <!-- CARD -->
  <div class="login-card">

    <!-- ===== LOGIN ===== -->
    <div id="loginBox">
      <h2 style="text-align:center">เข้าสู่ระบบ</h2>

      <div class="form-group">
        <input id="loginEmail" type="email" placeholder="Email" autocomplete="username">
      </div>

      <div class="form-group">
        <input id="loginPassword" type="password" placeholder="Password" autocomplete="current-password">
      </div>

      <button class="btn-login" id="loginBtn" onclick="login()">เข้าสู่ระบบ</button>

      <div class="register-link" style="text-align:center;margin-top:15px;">
        <a onclick="showRegister()">สมัครสมาชิก</a>
      </div>
    </div>

    <!-- ===== REGISTER ===== -->
    <div id="registerBox" class="hidden">
      <h2 style="text-align:center">สมัครสมาชิก IT</h2>

      <div class="form-group">
        <input id="regName" placeholder="ชื่อ - สกุล">
      </div>

      <div class="form-group">
        <input id="regEmail" type="email" placeholder="Email">
      </div>

      <div class="form-group">
        <input id="regPassword" type="password" placeholder="Password">
      </div>

      <button class="btn-login" id="regBtn" onclick="register()">สมัครสมาชิก</button>

      <div class="register-link" style="text-align:center;margin-top:15px;">
        <a onclick="showLogin()">กลับไปหน้า Login</a>
      </div>
    </div>

  </div>
</div>

<!-- ===== OVERLAY กลางระบบ ===== -->
<div id="overlay" class="overlay hidden">
  <div class="overlay-card">
    <div class="spinner"></div>
    <p id="overlayMsg">กำลังดำเนินการ...</p>
  </div>
</div>

<!-- ===== POPUP กลางระบบ ===== -->
<div id="popup" class="popup hidden">
  <div class="popup-card">
    <h3 id="popupTitle">แจ้งเตือน</h3>
    <p id="popupMsg">-</p>
    <button onclick="closePopup()">ตกลง</button>
  </div>
</div>

<script src="./js/ui.js"></script>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbzNSgpYNigJX7W-RUPq8SLN4e687pE55p72KsbM-nWFcPefKDhjzYAflsm78i42IW7qrw/exec';

/* ===== JSONP ===== */
function jsonp(url, cb){
  const s = document.createElement('script');
  s.src = url + '&callback=' + cb;
  document.body.appendChild(s);
  setTimeout(()=>s.remove(),3000);
}

/* ===== UI ===== */
function showRegister(){
  loginBox.classList.add('hidden');
  registerBox.classList.remove('hidden');
}
function showLogin(){
  registerBox.classList.add('hidden');
  loginBox.classList.remove('hidden');
}

/* ===== LOGIN ===== */
function login(){
  const btn = loginBtn;
  if(!loginEmail.value || !loginPassword.value){
    showPopup('ข้อมูลไม่ครบ','กรุณากรอก Email และ Password');
    return;
  }

  btn.disabled = true;
  showOverlay('กำลังตรวจสอบข้อมูล...');

  jsonp(
    GAS_URL +
    '?action=login' +
    '&email=' + encodeURIComponent(loginEmail.value) +
    '&password=' + encodeURIComponent(loginPassword.value),
    'loginCallback'
  );
}

function loginCallback(res){
  hideOverlay();
  loginBtn.disabled = false;

  if(res.success){
    showPopup('สำเร็จ','ยินดีต้อนรับ ' + res.user.name);
    // location.href = 'admin.html';
  }else{
    showPopup('ไม่สำเร็จ', res.message);
  }
}

/* ===== REGISTER ===== */
function register(){
  const btn = regBtn;
  if(!regName.value || !regEmail.value || !regPassword.value){
    showPopup('ข้อมูลไม่ครบ','กรุณากรอกข้อมูลให้ครบ');
    return;
  }

  btn.disabled = true;
  showOverlay('กำลังบันทึกข้อมูล...');

  jsonp(
    GAS_URL +
    '?action=register' +
    '&name=' + encodeURIComponent(regName.value) +
    '&email=' + encodeURIComponent(regEmail.value) +
    '&password=' + encodeURIComponent(regPassword.value),
    'registerCallback'
  );
}

function registerCallback(res){
  hideOverlay();
  regBtn.disabled = false;

  if(res.success){
    showPopup('สมัครสมาชิกสำเร็จ', res.message);
    showLogin();
  }else{
    showPopup('ผิดพลาด', res.message);
  }
}

/* ===== ENTER KEY ===== */
document.addEventListener('keydown', e=>{
  if(e.key === 'Enter'){
    if(!loginBox.classList.contains('hidden')) login();
    if(!registerBox.classList.contains('hidden')) register();
  }
});
</script>

</body>
</html>
