<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Admin : อนุมัติผู้ใช้งาน IT</title>

  <style>
    body {
      font-family: Tahoma, sans-serif;
      background: #f4f6f8;
      padding: 20px;
    }
    h2 {
      margin-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #2c3e50;
      color: #fff;
    }
    button {
      padding: 6px 12px;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
    .btn-on {
      background: #27ae60;
      color: #fff;
    }
    .btn-off {
      background: #c0392b;
      color: #fff;
    }
    .status-true {
      color: green;
      font-weight: bold;
    }
    .status-false {
      color: red;
      font-weight: bold;
    }
  </style>
</head>

<body>

<h2>ระบบอนุมัติผู้ใช้งาน IT</h2>

<table>
  <thead>
    <tr>
      <th>USER ID</th>
      <th>ชื่อผู้ใช้งาน</th>
      <th>User Login</th>
      <th>Email</th>
      <th>สถานะ</th>
      <th>จัดการ</th>
    </tr>
  </thead>
  <tbody id="userTable">
    <tr>
      <td colspan="6">กำลังโหลดข้อมูล...</td>
    </tr>
  </tbody>
</table>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbzNSgpYNigJX7W-RUPq8SLN4e687pE55p72KsbM-nWFcPefKDhjzYAflsm78i42IW7qrw/exec'; // <-- ใส่ URL Web App ที่ deploy แล้ว

function jsonp(url, callbackName) {
  const script = document.createElement('script');
  script.src = url + '&callback=' + callbackName;
  document.body.appendChild(script);
  setTimeout(() => script.remove(), 3000);
}

// โหลดรายชื่อ User
function loadUsers() {
  jsonp(
    GAS_URL + '?action=getPendingUsers',
    'renderUsers'
  );
}

function renderUsers(res) {
  const tb = document.getElementById('userTable');
  tb.innerHTML = '';

  if (!res.success || res.data.length === 0) {
    tb.innerHTML = '<tr><td colspan="6">ไม่พบข้อมูล</td></tr>';
    return;
  }

  res.data.forEach(u => {
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td>${u.userid}</td>
      <td>${u.name}</td>
      <td>${u.userlogin}</td>
      <td>${u.email}</td>
      <td class="${u.active ? 'status-true' : 'status-false'}">
        ${u.active ? 'ใช้งานได้' : 'รออนุมัติ'}
      </td>
      <td>
        <button class="${u.active ? 'btn-off' : 'btn-on'}"
          onclick="toggleUser('${u.userlogin}', ${!u.active})">
          ${u.active ? 'ปิดใช้งาน' : 'อนุมัติ'}
        </button>
      </td>
    `;
    tb.appendChild(tr);
  });
}

// เปิด / ปิด User
function toggleUser(userlogin, active) {
  if (!confirm('ยืนยันการเปลี่ยนสถานะผู้ใช้งาน ?')) return;

  jsonp(
    GAS_URL +
    '?action=approveUser' +
    '&userlogin=' + encodeURIComponent(userlogin) +
    '&active=' + active,
    'afterApprove'
  );
}

function afterApprove(res) {
  if (res.success) {
    alert('บันทึกเรียบร้อย');
    loadUsers();
  } else {
    alert(res.message || 'เกิดข้อผิดพลาด');
  }
}

loadUsers();
</script>

</body>
</html>
