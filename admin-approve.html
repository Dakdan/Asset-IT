<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Admin Approval</title>
<link rel="stylesheet" href="./css/style.css">
<style>
body{
  background:#fce4ec;
  padding:20px;
  display:block;
}
h2{ margin-bottom:15px; }
</style>
</head>

<body>

<h2>üëë Admin : ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô IT</h2>

<table class="table admin-table">
  <thead>
    <tr>
      <th>Email</th>
      <th>‡∏ä‡∏∑‡πà‡∏≠</th>
      <th>‡∏™‡∏Å‡∏∏‡∏•</th>
      <th>Username</th>
      <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
      <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
    </tr>
  </thead>
  <tbody id="list"></tbody>
</table>

<!-- Overlay -->
<div id="overlay" class="overlay hidden">
  <div class="overlay-card">
    <div class="spinner"></div>
    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</p>
  </div>
</div>

<script>
/************** CONFIG **************/
const API_URL = 'YOUR_DEPLOYED_GAS_URL'; // << ‡πÉ‡∏™‡πà URL ‡∏ó‡∏µ‡πà deploy ‡πÅ‡∏•‡πâ‡∏ß

/************** SESSION **************/
const user = JSON.parse(localStorage.getItem('it_user'));
if(!user || user.role !== 'ADMIN'){
  location.href = 'login.html';
}

/************** UTIL **************/
function showOverlay(show){
  document.getElementById('overlay').classList.toggle('hidden', !show);
}
function jsonp(url){
  return new Promise(res=>{
    const cb = 'cb'+Date.now();
    window[cb]=data=>{ delete window[cb]; res(data); };
    const s=document.createElement('script');
    s.src=url+'&callback='+cb;
    document.body.appendChild(s);
  });
}

/************** LOAD VERIFIED **************/
async function loadVerified(){
  showOverlay(true);
  const r = await jsonp(`${API_URL}?action=getVerified`);
  showOverlay(false);

  if(!r.success) return alert(r.message);

  const tb = document.getElementById('list');
  tb.innerHTML = '';

  r.data.forEach(row=>{
    tb.innerHTML += `
      <tr>
        <td data-label="Email">${row[1]}</td>
        <td data-label="‡∏ä‡∏∑‡πà‡∏≠">${row[2]}</td>
        <td data-label="‡∏™‡∏Å‡∏∏‡∏•">${row[3]}</td>
        <td data-label="Username">${row[4]}</td>
        <td data-label="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" class="status-true">VERIFIED</td>
        <td data-label="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£">
          <button class="btn-success" onclick="approve('${row[1]}')">
            ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
          </button>
        </td>
      </tr>
    `;
  });
}

/************** APPROVE **************/
async function approve(email){
  if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ '+email+' ?')) return;
  showOverlay(true);

  const r = await jsonp(`${API_URL}?action=approveIT&email=${encodeURIComponent(email)}`);
  showOverlay(false);

  alert(r.message);
  if(r.success) loadVerified();
}

/************** INIT **************/
loadVerified();
</script>

</body>
</html>
